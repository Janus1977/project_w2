<?php
		//Generated by ManagerGenerator::generate() on 03/10/2017 14:32:14
class ManagerUnite {
	/** Instance de la classe (managerUnite) */
	private static $_instance = null;

	/** Connexion a la base de donnees (database) */
	private static $_oConnexion = null;

	/** Liste des objet de la classe (Unite) */
	private static $_aListeUnite = array();

	/*
	 * Entre ces deux balises vous pourrez mettre votre code specifique a la classe.
	 * Il sera preserve lors de la reconstruction automatique.
	 */
	/*[TAG-Unite11]*/	/*[/TAG-Unite11]*/


	protected function __construct() {
		//Generated by ManagerGenerator::generateConstruct() on 03/10/2017 14:32:14
	}

	public function __destruct() {
		//Generated by ManagerGenerator::generateDestruct() on 03/10/2017 14:32:14
		// TODO ??
	}

	public static function getInstance() {
		//Generated by ManagerGenerator::generateGetInstance() on 03/10/2017 14:32:14
		if (is_null(self::$_instance)) {
			self::$_instance = new self;
		}
		return self::$_instance;
	}

	public function __clone() {
		//Generated by ManagerGenerator::generateClone() on 03/10/2017 14:32:14
		throw new Exception(get_class($this).": Le clonage n'est pas autoris&eacute;", E_USER_ERROR);
	}

	public function setConnexion() {
		//Generated by ManagerGenerator::generateSetConnexion() on 03/10/2017 14:32:14
		self::$_oConnexion = database::getInstance();// pas besoin de parametrer, un manager arrive apres la conf
	}

	public function __set($name,$id) {
		//Generated by ManagerGenerator::generateSet() on 03/10/2017 14:32:14
		throw new Exception(get_class($this).": Le set 'noname' n'est pas autoris&eacute;", E_USER_ERROR);
	}

	public function __get($name) {
		//Generated by ManagerGenerator::generateGet() on 03/10/2017 14:32:14
		throw new Exception(get_class($this).": Le get 'noname' n'est pas autoris&eacute;", E_USER_ERROR);
	}

	public function getById($id=-1) {
		//Generated by ManagerGenerator::generateGetById() on 03/10/2017 14:32:14
		if ($id == -1) {
			//Toute les informations
			return FactoryUnite::getFromTableUnite($id);
		} else {
			//Verification si l'objet n'est pas en memoire
			if ($id > 0 && !array_key_exists($id,self::$_aListeUnite)) {
				self::$_aListeUnite[$id] = FactoryUnite::getFromTableUnite($id);
			}
		}
		return self::$_aListeUnite[$id];
	}

	public function getFromExtTableEquipementarmegauche($equipementarmegauche=-1) {
		//Generated by ManagerGenerator::generateGetFromTableFromFK() on 03/10/2017 14:32:14
		//Verification en memoire
		foreach (self::$_aListeUnite AS $oUnite) {
			if ($oUnite->getEquipementarmegauche() == $equipementarmegauche) {
				return $oUnite;
			}
		}
		// Appel de la methode de la Fabrique
		$oUnite = FactoryUnite::getFromExtTableEquipementarmegauche($equipementarmegauche);
		// Memorisation pour plus tard
		self::$_aListeUnite[$oUnite->getId()] = $oUnite;
		// Renvoie de la donnee
		return $oUnite;
	}

	public function deleteCompositeLinksFromEquipementarmegauche($idequipementarmegauche) {
		//Generated by ManagerGenerator::generateDeleteCompositeLinks() on 03/10/2017 14:32:14
		//TODO
	}

	public function getFromExtTableEquipementarmedroite($equipementarmedroite=-1) {
		//Generated by ManagerGenerator::generateGetFromTableFromFK() on 03/10/2017 14:32:14
		//Verification en memoire
		foreach (self::$_aListeUnite AS $oUnite) {
			if ($oUnite->getEquipementarmedroite() == $equipementarmedroite) {
				return $oUnite;
			}
		}
		// Appel de la methode de la Fabrique
		$oUnite = FactoryUnite::getFromExtTableEquipementarmedroite($equipementarmedroite);
		// Memorisation pour plus tard
		self::$_aListeUnite[$oUnite->getId()] = $oUnite;
		// Renvoie de la donnee
		return $oUnite;
	}

	public function deleteCompositeLinksFromEquipementarmedroite($idequipementarmedroite) {
		//Generated by ManagerGenerator::generateDeleteCompositeLinks() on 03/10/2017 14:32:14
		//TODO
	}

	public function getFromExtTableEquipementarmure($equipementarmure=-1) {
		//Generated by ManagerGenerator::generateGetFromTableFromFK() on 03/10/2017 14:32:14
		//Verification en memoire
		foreach (self::$_aListeUnite AS $oUnite) {
			if ($oUnite->getEquipementarmure() == $equipementarmure) {
				return $oUnite;
			}
		}
		// Appel de la methode de la Fabrique
		$oUnite = FactoryUnite::getFromExtTableEquipementarmure($equipementarmure);
		// Memorisation pour plus tard
		self::$_aListeUnite[$oUnite->getId()] = $oUnite;
		// Renvoie de la donnee
		return $oUnite;
	}

	public function deleteCompositeLinksFromEquipementarmure($idequipementarmure) {
		//Generated by ManagerGenerator::generateDeleteCompositeLinks() on 03/10/2017 14:32:14
		//TODO
	}

	public function getFromExtTableEquipementcoiffe($equipementcoiffe=-1) {
		//Generated by ManagerGenerator::generateGetFromTableFromFK() on 03/10/2017 14:32:14
		//Verification en memoire
		foreach (self::$_aListeUnite AS $oUnite) {
			if ($oUnite->getEquipementcoiffe() == $equipementcoiffe) {
				return $oUnite;
			}
		}
		// Appel de la methode de la Fabrique
		$oUnite = FactoryUnite::getFromExtTableEquipementcoiffe($equipementcoiffe);
		// Memorisation pour plus tard
		self::$_aListeUnite[$oUnite->getId()] = $oUnite;
		// Renvoie de la donnee
		return $oUnite;
	}

	public function deleteCompositeLinksFromEquipementcoiffe($idequipementcoiffe) {
		//Generated by ManagerGenerator::generateDeleteCompositeLinks() on 03/10/2017 14:32:14
		//TODO
	}

	public function getFromExtTableEquipementetendart($equipementetendart=-1) {
		//Generated by ManagerGenerator::generateGetFromTableFromFK() on 03/10/2017 14:32:14
		//Verification en memoire
		foreach (self::$_aListeUnite AS $oUnite) {
			if ($oUnite->getEquipementetendart() == $equipementetendart) {
				return $oUnite;
			}
		}
		// Appel de la methode de la Fabrique
		$oUnite = FactoryUnite::getFromExtTableEquipementetendart($equipementetendart);
		// Memorisation pour plus tard
		self::$_aListeUnite[$oUnite->getId()] = $oUnite;
		// Renvoie de la donnee
		return $oUnite;
	}

	public function deleteCompositeLinksFromEquipementetendart($idequipementetendart) {
		//Generated by ManagerGenerator::generateDeleteCompositeLinks() on 03/10/2017 14:32:14
		//TODO
	}

	public function getFromExtTableCamp($camp=-1) {
		//Generated by ManagerGenerator::generateGetFromTableFromFK() on 03/10/2017 14:32:14
		//Verification en memoire
		foreach (self::$_aListeUnite AS $oUnite) {
			if ($oUnite->getCamp() == $camp) {
				return $oUnite;
			}
		}
		// Appel de la methode de la Fabrique
		$oUnite = FactoryUnite::getFromExtTableCamp($camp);
		// Memorisation pour plus tard
		self::$_aListeUnite[$oUnite->getId()] = $oUnite;
		// Renvoie de la donnee
		return $oUnite;
	}

	public function deleteCompositeLinksFromCamp($idcamp) {
		//Generated by ManagerGenerator::generateDeleteCompositeLinks() on 03/10/2017 14:32:14
		//TODO
	}

	public function getFromExtTableDimension($dimension=-1) {
		//Generated by ManagerGenerator::generateGetFromTableFromFK() on 03/10/2017 14:32:14
		//Verification en memoire
		foreach (self::$_aListeUnite AS $oUnite) {
			if ($oUnite->getDimension() == $dimension) {
				return $oUnite;
			}
		}
		// Appel de la methode de la Fabrique
		$oUnite = FactoryUnite::getFromExtTableDimension($dimension);
		// Memorisation pour plus tard
		self::$_aListeUnite[$oUnite->getId()] = $oUnite;
		// Renvoie de la donnee
		return $oUnite;
	}

	public function deleteCompositeLinksFromDimension($iddimension) {
		//Generated by ManagerGenerator::generateDeleteCompositeLinks() on 03/10/2017 14:32:14
		//TODO
	}

	public function getFromExtTableTile($tile=-1) {
		//Generated by ManagerGenerator::generateGetFromTableFromFK() on 03/10/2017 14:32:14
		//Verification en memoire
		foreach (self::$_aListeUnite AS $oUnite) {
			if ($oUnite->getTile() == $tile) {
				return $oUnite;
			}
		}
		// Appel de la methode de la Fabrique
		$oUnite = FactoryUnite::getFromExtTableTile($tile);
		// Memorisation pour plus tard
		self::$_aListeUnite[$oUnite->getId()] = $oUnite;
		// Renvoie de la donnee
		return $oUnite;
	}

	public function deleteCompositeLinksFromTile($idtile) {
		//Generated by ManagerGenerator::generateDeleteCompositeLinks() on 03/10/2017 14:32:14
		//TODO
	}

	public function delete($object=array()) {
		//Generated by ManagerGenerator::generateDelete() on 03/10/2017 14:32:14
		// Verification
		if (empty($object)) {
			throw new Exception(get_class($this).": La suppression se fait sur un objet.", E_USER_ERROR);
		}
		// si ce n'est pas une instance de la classe, on la cree
		if (! $object instanceof Unite) {
			$oUnite = new Unite($object['id'],$object['nom'],$object['description'],$object['def_av'],$object['def_ar'],$object['def_g'],$object['def_d'],$object['mouvement'],$object['capacite'],$object['pilote'],$object['co_pilote'],$object['experience'],$object['equipementarmegauche'],$object['equipementarmedroite'],$object['equipementarmure'],$object['equipementcoiffe'],$object['equipementetendart'],$object['toucher'],$object['initiative'],$object['sauvegarde'],$object['endurance'],$object['cac'],$object['fo'],$object['attaque'],$object['intell'],$object['ty'],$object['camp'],$object['cout'],$object['date_creation'],$object['chemin'],$object['dimension'],$object['aattaquecetour'],$object['sestdeplacecetour'],$object['achargecetour'],$object['tile'],$object['pdv'],$object['ingame']);
		} else {
			$oUnite = $object;
		}
		// Appel de la methode delete de l'objet
		// Tout se passe dans une transaction ouverte plus haut
			// Execution de la requete
		if (database::getInstance()->executeRequete($oUnite->delete())) {
			// Requete OK
			unset(self::$_aListeUnite[$oUnite->getId()]);
			return true;
		} else {
			// Requete NOK lancement d'une exception PDO
			throw new PDOException('Erreur sur delete (Unite)');
		}
	}

	public function update($object=array()) {
		//Generated by ManagerGenerator::generateUpdate() on 03/10/2017 14:32:14
		// Verification
		if (empty($object)) {
			throw new Exception(get_class($this).": la mise &agrave; jour se fait sur un objet.", E_USER_ERROR);
		}
		// si ce n'est pas une instance de la classe, on la cree
		if (! $object instanceof Unite) {
			$oUnite = new Unite($object['id'],$object['nom'],$object['description'],$object['def_av'],$object['def_ar'],$object['def_g'],$object['def_d'],$object['mouvement'],$object['capacite'],$object['pilote'],$object['co_pilote'],$object['experience'],$object['equipementarmegauche'],$object['equipementarmedroite'],$object['equipementarmure'],$object['equipementcoiffe'],$object['equipementetendart'],$object['toucher'],$object['initiative'],$object['sauvegarde'],$object['endurance'],$object['cac'],$object['fo'],$object['attaque'],$object['intell'],$object['ty'],$object['camp'],$object['cout'],$object['date_creation'],$object['chemin'],$object['dimension'],$object['aattaquecetour'],$object['sestdeplacecetour'],$object['achargecetour'],$object['tile'],$object['pdv'],$object['ingame']);
		} else {
			$oUnite = $object;
		}
		// Maintenant on compare avec celle en session
		if (!empty($_SESSION['unite']) && sizeof($_SESSION['unite']->compareTo($oUnite)) > 0) {
			$_SESSION['unite'] = $oUnite;
		}
		if ($oUnite->getId() == 0) {
			//Go TO SAVE
			self::save($oUnite);
		} else {
			// on update car les objets sont different
			if (database::getInstance()->executeRequete($oUnite->update()) === true) {
				//maj id dans la liste
				self::$_aListeUnite[$oUnite->getId()] = $oUnite;
				return true;
			} else {
				return false;
			}
		}
	}

	public function save($object=array()) {
		//Generated by ManagerGenerator::generateSave() on 03/10/2017 14:32:14
		// Verification
		if (empty($object)) {
			throw new Exception(get_class($this).": la sauvegarde se fait sur un objet.", E_USER_ERROR);
		}
		// si ce n'est pas une instance de la classe, on la cree
		if (! $object instanceof Unite) {
			$oUnite = new Unite($object['id'],$object['nom'],$object['description'],$object['def_av'],$object['def_ar'],$object['def_g'],$object['def_d'],$object['mouvement'],$object['capacite'],$object['pilote'],$object['co_pilote'],$object['experience'],$object['equipementarmegauche'],$object['equipementarmedroite'],$object['equipementarmure'],$object['equipementcoiffe'],$object['equipementetendart'],$object['toucher'],$object['initiative'],$object['sauvegarde'],$object['endurance'],$object['cac'],$object['fo'],$object['attaque'],$object['intell'],$object['ty'],$object['camp'],$object['cout'],$object['date_creation'],$object['chemin'],$object['dimension'],$object['aattaquecetour'],$object['sestdeplacecetour'],$object['achargecetour'],$object['tile'],$object['pdv'],$object['ingame']);
		} else {
			$oUnite = $object;
		}
		if ($oUnite->getId() > 0) {
			//Go TO UPDATE
			self::update($oUnite);
		} else {
			// Appel de la methode update de l'objet
			if (database::getInstance()->executeRequete($oUnite->save()) === true) {
				//maj id dans la liste
				self::$_aListeUnite[$oUnite->getId()] = $oUnite;
				return true;
			} else {
				return false;
			}
		}
	}

	public function findBy($champ,$data='') {
		//Generated by ManagerGenerator::generateFindBy() on 03/10/2017 14:32:14
		// creation d'un objet de base de la classe
		$object = new Unite();
		$resultat = array();
		for ($i = 0; $i < sizeof($this -> _aListeUnite); $i++) {
			$object = $this -> _aListeUnite[$i];
			if ($object -> {'_'.strtolower($champ)} == $data) {
				$resultat[] = $object;
			}
		}
		if (sizeof($resultat) > 0) {
			//existe
			return $resultat;
		} else {
			//n'existe pas
			return "Pas de Unite de ".strtolower($champ)." '".$data."'";
		}
	}

	public function getUniteVide() {
		//Generated by ManagerGenerator::generateGetObjetVide() on 03/10/2017 14:32:14
		return new Unite();
	}


	/*
	 * Entre ces deux balises vous pourrez mettre votre code specifique a la classe.
	 * Il sera preserve lors de la reconstruction automatique.
	 */
	/*[TAG-Unite21]*/
	
	/**
	 * l'attaque pour une unite consiste a ataquer une ou plusieurs unite
	 * Nous partons du principe que les unites concernees n'ont pas attaque ce tour
	 * dans le rayon d'acion de son arme
	 */
	public function attaque($oUniteAttaquante,$oUniteDefensive=null) {
		if (empty($oUniteAttaquante)) {
			alerte("ERREUR, Impossible, il faut au moins l'attaquant.");
			return;
		}
		
		if (!is_null($oUniteAttaquante) && $oUniteAttaquante->getIngame() == 0) {
			alerte("ERREUR, Impossible, l'attaquant est hors jeu.");
			return;
		}
		
		if (!is_null($oUniteDefensive) && $oUniteDefensive->getIngame() == 0) {
			alerte("ERREUR, Impossible, le d&eacute;fenseur est hors jeu.");
			return;
		}
		
		//Verifications sur l'attaquant
		if ($oUniteAttaquante instanceof Unite) {
			//ce test est necessaire car au cours d'un combat,
			//une arme peu ne plus etre disponible
			//canAttack retourne un tableau:
			//[0]=> 0/1 impossible/possible
			//[1]=> instance de ActionAttaque
			$attaque = $oUniteAttaquante->canAttack();
			
			if ($attaque[0] == 0) {
				alerte("Atttaque Impossible, pas d'arme");
				return;
			} else {
				// A partir d'ici, nous savons si l'unite peut ou non attaquer
				
				// L'unite n'est pas sur une carte ==> impossible
				$oCaseAttaquant = ManagerTile::getInstance()->getById($oUniteAttaquante->getTile());
				
				$MaxPorteeTir = max($oUniteAttaquante->getPorteeArme());
// 				if (empty($oCaseAttaquant)) {
// 					$oCaseAttaquant = FactoryTile::getFromExtTableUnitejoueur($attaquant->getId());
// 					if (empty($oCaseAttaquant)) {
// 						alerte("L'unite attaquante n'est pas sur une table de jeu");
// 						return;
// 					}
// 				}

				if (!is_null($oUniteDefensive)) {
					//Attaque ciblee sur une unite/equipement
					$listeCasesAAttaquer[] = ManagerTile::getInstance()->getById($oUniteDefensive->getTile());
				} else {
					/* 2) Chargement des unites presentes dans le rayon d'action de l'arme */
// 					$listeCasesAAttaquer = $this->isThereEnnemies($oCaseAttaquant,$oUniteAttaquante->getPorteeArme());
				    $listeCasesAAttaquer = $this->isThereEnnemies($oCaseAttaquant,$MaxPorteeTir);
				}
				
				// Maintenant il faut parcourir la liste des unites presentes et lancer les attaques
				foreach ($listeCasesAAttaquer AS $oCase) {
					$resultCompare = $oCase->compareTo($oCaseAttaquant);
					if (!empty($resultCompare)) {
						//La case n'est pas la mienne
						if (!empty($attaque[1])) {
							//L'objet ActionAttaque existe bien
							debug("Attaque case (".$oCase->getId().", x".$oCase->getX()."/y".$oCase->getY().")",true);
							
							//si le rayon d'action de l'arme et 1 => corps-a-corps
							//sinon tir
// 							$MaxPorteeTir = max($oUniteAttaquante->getPorteeArme());
// 							if (max($oUniteAttaquante->getPorteeArme()) == 1) {
							if ($MaxPorteeTir == 1) {
								//corps-a-corps
								if (ManagerTile::getInstance()->distanceEntre($oCaseAttaquant, $oCase) == 1) {
									debug("Corps-a-corps",true);
									if ( $attaque[1]->attaque($oUniteAttaquante,$oUniteDefensive) === false) {
										return;
									}
									
									//resolution des blessures
									if ($attaque[1]->getBlessures() > 0) {
										debug("Blessure Corps-a-corps: ".$attaque[1]->getBlessures(),true);
										debug("Assignation des blessures Corps-a-corps",true);
										$oUniteDefensive->encaisse($attaque[1]->getBlessures());
										if ($oUniteDefensive->getPdv() <= 0) {
											debug("Unit&eacute; d&eacute;truite.",true);
											//on la sort du terrain de jeu
											self::setUnitOutOfGame($oUniteDefensive);
											$oUniteDefensive->setIngame(0);
											debug("Unit&eacute; retir&eacute;e de la partie.",true);
										}
									}
									
									//riposte du defenseur si elle est possible
									//Test de commandement ssi pas attaque le tour d'avant
									if ($oUniteDefensive->getIngame() == 1 && $oUniteDefensive->getAAttaqueCeTour() == 0) {
										$lancerCommandement = lanceDes2(array('2D6'));
										
										if ($lancerCommandement < $oUniteDefensive->getInitiative()) {
											debug("test reussi: ".$lancerCommandement." < ".$oUniteDefensive->getInitiative(),true);
											$riposte = $oUniteDefensive->canAttack();
											if (!empty($riposte[1])) {
												//L'objet ActionAttaque existe bien
												debug("riposte",true);
												$riposte[1]->attaque($oUniteDefensive,$oUniteAttaquante);
												if ($riposte[1]->getBlessures() > 0) {
													debug("Blessure riposte Corps-a-corps: ".$riposte[1]->getBlessures(),true);
													debug("Assignation des blessures riposte Corps-a-corps",true);
													$oUniteAttaquante->encaisse($riposte[1]->getBlessures());
													if ($oUniteAttaquante->getPdv() <= 0) {
														debug("Unit&eacute; d&eacute;truite.",true);
														//on la sort du terrain de jeu
														self::setUnitOutOfGame($oUniteAttaquante);
														$oUniteAttaquante->setIngame(0);
														debug("Unit&eacute; retir&eacute;e de la partie.",true);
													}
												}
											}
										} else {
											debug("test KO: ".$lancerCommandement." > ".$oUniteDefensive->getInitiative(),true);
										}
									}
								}
							} else {
								//tir
// 								if ($oCaseAttaquant->distanceAvec($oCase) <= floor(max($rayon) / 2)) {
// 								if (ManagerTile::getInstance()->distanceEntre($oCaseAttaquant, $oCase) <= floor(max($oUniteAttaquante->getPorteeArme()) / 2)) {
							    if (ManagerTile::getInstance()->distanceEntre($oCaseAttaquant, $oCase) <= floor($MaxPorteeTir / 2)) {
							        //Tir rapide possible == 2 tirs sur rayon / 2
									//test car il faut l'implementer dans la base
									debug("Distance == 1/2 R => Tir rapide attaque 1/2",true);
									$attaque[1]->attaque($oUniteAttaquante,$oUniteDefensive);
									//resolution des blessures
									if ($attaque[1]->getBlessures() > 0) {
										debug("premieres blessure du tir rapide 1: ".$attaque[1]->getBlessures(),true);
										debug("Assignation des blessures du tir rapide 1/2",true);
										$oUniteDefensive->encaisse($attaque[1]->getBlessures());
										if ($oUniteDefensive->getPdv() > 0) {
											debug("Distance == 1/2 R => Tir rapide attaque 2/2",true);
											$attaque[1]->attaque($oUniteAttaquante,$oUniteDefensive);
											if ($attaque[1]->getBlessures() > 0) {
												debug("Blessure(s) du tir rapide 2: ".$attaque[1]->getBlessures(),true);
												debug("Assignation des blessures du tir rapide 2/2",true);
												$oUniteDefensive->encaisse($attaque[1]->getBlessures());
												if ($oUniteDefensive->getPdv() < 0) {
													debug("Unit&eacute; d&eacute;truite.",true);
													//on la sort du terrain de jeu
													self::setUnitOutOfGame($oUniteDefensive);
													$oUniteDefensive->setIngame(0);
													debug("Unit&eacute; retir&eacute;e de la partie.",true);
												}
											} else {
												debug("Pas de blessures",true);
											}
										} else {
											debug("Unit&eacute; d&eacute;truite.",true);
											//on la sort du terrain de jeu
											self::setUnitOutOfGame($oUniteDefensive);
											$oUniteDefensive->setIngame(0);
											debug("Unit&eacute; retir&eacute;e de la partie.",true);
										}
									} else {
										debug("Pas de blessures",true);
									}
								} else {//FIN TIR RAPIDE
									//tir classique == 1 tir
									debug("Tir Normal",true);
									$attaque[1]->attaque($oUniteAttaquante,$oUniteDefensive);
								}
								//riposte du defenseur si elle est possible
								//Test de commandement ssi pas attaque le tour d'avant
								//ICI voir commandement == initiative //
								if ($oUniteDefensive->getIngame() == 1 && $oUniteDefensive->getAAttaqueCeTour() == 0) {
									$lancerCommandement = lanceDes2(array('2D6'));
									if ($lancerCommandement < $oUniteDefensive->getInitiative()) {
										debug("Test Cd reussi => riposte: ".$lancerCommandement." < ".$oUniteDefensive->getInitiative(),true);
									} else {
										debug("Test Cd KO: ".$lancerCommandement." > ".$oUniteDefensive->getInitiative(),true);
									}
								}
							}
						}
					} //FIN IF "CE N'EST PAS MA CASE"
				} //FIN FOREACH
			} // FIN ELSE PEUT ATTAQUER
		} //FIN PARTIE UNITE / UNITE_JOUEUR
		
		//l'attaquant est un equipement mais on a appele cette methode par ereur => redirection
		if ($oUniteAttaquante instanceof Equipement) {
			// C'est un equipement que a l'action d'attaque (Ex: mine)
			ManagerEquipement::getInstance()->attaque($oUniteAttaquante,$oUniteDefensive);
		}//FIN PARTIE EQUIPEMENT / EQUIPEMENT_JOUEUR
	}


	/**
	 * Methode de recherche d'ennemis dans le rayon de l'arme de l'unite
	 * @param Tile $oCaseAttaquant
	 * @param array $rayonArme
	 * @return array <multitype:Tile, multitype:Tile >
	 */
	public function isThereEnnemies($oCaseAttaquant,$rayonArme) {
		// la liste des cases dans le rayon de l'arme
		$xMin = $oCaseAttaquant->getX() - intval(max($rayonArme));
		if ($xMin < 0) {
			$xMin = 0;
		}
		$xMax = $oCaseAttaquant->getX() + intval(max($rayonArme));
		$yMin = $oCaseAttaquant->getY() - intval(max($rayonArme));
		if ($yMin < 0) {
			$yMin = 0;
		}
		$yMax = $oCaseAttaquant->getY() + intval(max($rayonArme));
		
		return FactoryTile::getEnnemiesCasesFromRange($oCaseAttaquant->getCarte(),$oCaseAttaquant->getId(),$xMin,$xMax,$yMin,$yMax);
	}
	
	/**
	 * Methode pour sortir des Unites du plateau de jeu (mort par exemple)
	 * @param unknown $oUnite
	 * @throws PDOException
	 * @return boolean
	 */
	public function setUnitOutOfGame($oUnite) {
// 		foreach ($aUnites AS $oUnite) {
			if ($oUnite instanceof Unite_joueur) {
				ManagerUnite_joueur::getInstance()->setUnitOutOfGame($oUnite);
			} else {
				$requete = "UPDATE unite SET tile = 0,ingame = 0 ";
				$requete .= "WHERE id =  :id";
				database::getInstance()->prepareRequete($requete);
				database::getInstance()->bind(array('id' => $oUnite->getId()));
				if (database::getInstance()->executeRequete()) {
					//meme chose sur la case
					$requete = "UPDATE tile SET unite = 0 ";
					$requete .= "WHERE unite = :unite";
					database::getInstance()->prepareRequete($requete);
					database::getInstance()->bind(array('unite' => $oUnite->getId()));
					return database::getInstance()->executeRequete();
				} else {
					throw new PDOException('Erreur sur setUnitOutOfGame (Unite)');
				}
			}			
// 		}
	}
	
	/**
	 * Methode de remise en jeu d'une Unite
	 * @param unknown $oUnite
	 * @throws PDOException
	 */
	public function setUnitInGame($oUnite,$idTile) {
		if ($oUnite instanceof Unite_joueur) {
// 			ManagerUnite_joueur::getInstance()->setUnitInGame($oUnite);
		} else {
			$retour = true;
			$requete = "UPDATE unite SET tile = :tile, ingame = 1 ";
			$requete .= "WHERE id =  :id";
			database::getInstance()->prepareRequete($requete);
			database::getInstance()->bind(array('id' => $oUnite->getId(),'tile' => $idTile));
			//UPDATE retourne le nombre de ligne modifiees
			$retour = database::getInstance()->executeRequete();
			//meme chose sur la case
			$requete = "UPDATE tile SET unite = :unite ";
			$requete .= "WHERE id = :id";
			database::getInstance()->prepareRequete($requete);
			database::getInstance()->bind(array('id' => $idTile,'unite' => $oUnite->getId()));
			//UPDATE retourne le nombre de ligne modifiees
			$retour = database::getInstance()->executeRequete();
		}
		return $retour;
	}
	
	
	/**
	 * Methode pour sortir toutes les Unites du plateau de jeu, a partir de l'identifiant du plateau
	 * @param unknown $idCarte
	 * @throws PDOException
	 * @return boolean
	 */
	public function setUnitsOutOfGameFromMapId($idCarte) {
		$requete = "UPDATE unite SET tile = 0,ingame = 0 ";
		$requete .= "WHERE tile IN (SELECT id FROM tile WHERE carte = :carte)";
		database::getInstance()->prepareRequete($requete);
		database::getInstance()->bind(array('carte' => $idCarte));
		if (database::getInstance()->executeRequete()) {
			//meme chose sur la case
			$requete = "UPDATE tile SET idunite = 0 ";
			$requete .= "WHERE carte = :carte ";
			database::getInstance()->prepareRequete($requete);
			database::getInstance()->bind(array('carte' => $idCarte));
			return database::getInstance()->executeRequete();	
		} else {
			throw new PDOException('Erreur sur setUnitsOutOfGame (Unite)');
		}
	}
	
	/**
	 * Methode pour enlever une unite de la case, le parametre est l'unite.
	 * @param unknown $oUnite
	 * @throws PDOException
	 * @return boolean
	 */
	public function setUnitOutOfCase($oUnite) {
		if ($oUnite instanceof Unite_joueur) {
			ManagerUnite_joueur::getInstance()->setUnitOutOfCase($oUnite);
		} else {
			$requete = "UPDATE unite SET tile = 0 ";
			$requete .= "WHERE id = :id";
			database::getInstance()->prepareRequete($requete);
			database::getInstance()->bind(array('id' => $oUnite->getId()));
			if (database::getInstance()->executeRequete()) {
				//meme chose sur la case
				$requete = "UPDATE tile SET unite = 0 ";
				$requete .= "WHERE unite = unite";
				database::getInstance()->prepareRequete($requete);
				database::getInstance()->bind(array('unite' => $oUnite->getId()));
				return database::getInstance()->executeRequete();
			} else {
				throw new PDOException('Erreur sur setUnitsOutOfCase (Unite)');
			}
		}
	}
	
	/**
	 * Retourne la liste des unites sur une case (quelle que soit la carte)
	 * @return Ambigous <multitype:Unite , unknown>
	 */
	public function getUnitOnTileList() {
		//ATTENTION IL FAUDRA MODIFIER LE FACTORYGENERATOR
		return FactoryUnite::getFromExtTableTile();
	}
	
	public function getAllUnits() {
		if (!empty(self::$_aListeUnite)) {
			return self::$_aListeUnite;
		}
	}
	
	/**
	 * Changement d'arme de l'unite
	 * @param int $idUnite
	 * @param int $idEquipement
	 */
	public function switchWeapon($idUnite,$idEquipement) {
		//Creation de l'objet Unite
		$oUnite = self::getById(intval($idUnite));
		if (($oUnite->getEquipementarmegauche() == $idEquipement) ||
		    ($oUnite->getEquipementarmedroite() == $idEquipement)){
		    debug("Arme d&eacute;j&agrave; &eacute;quip&eacute;e",true);
		    return;
		}
		//Creation de l'objet Equipement
		$oEquipement = ManagerEquipement::getInstance()->getById(intval($idEquipement));
		//mise a jour de la nouvelle arme
		if ($oEquipement->getDeux_mains() == 1) {
			$oUnite->setEquipementarmedroite(intval($idEquipement));
			$oUnite->setEquipementarmegauche(intval($idEquipement));
		} else {
			$oUnite->setEquipementarmedroite(intval($idEquipement));
			$oUnite->setEquipementarmegauche(0);
		}		
		//sauvegarde de l'Unite
		self::update($oUnite);
	}
	
	/**
	 * Recherche d'une unite engagee au corps-a-corps avec l'unite
	 * @param unknown $oUnite
	 */
	public function fightLockOn($oUnite) {
		ManagerTile::getInstance()->setCasesAdjacentes($oUnite->getTileObject(), $oUnite->getTileObject()->getCarte());
		foreach (ManagerTile::getInstance()->getCasesAdjacentes() AS $oCase) {
			//si une case adjacente a celle de l'unite est occupee par une unite,
			//alors on considere l'unite bloquee et ne pouvant pas tirer ou être ciblée
			if ($oCase->getUnite() > 0 || $oCase->getUnite_joueur() > 0) {
				return true;
			}
		}
		//aucune unite engagee
		return false;
	}
	
	public function getPlayableUnitsForIA($idCarte = -1) {
	    if ($idCarte == -1) {
	        throw new Exception("Un identifiant de Carte est n&eacute;cessaire.");
	    }
	    return FactoryUnite::getPlayableUnitsForIA($idCarte);
	}
	/*[/TAG-Unite21]*/


}
?>